#!/bin/bash
# compile plots generated by compare_runs

if (($# == 0))
then
	echo usage: $0 [dir1 dir2]
	echo metrics are defined by GANGLIA_METRICS in \$PATH/spark_vars 
	exit
fi

#=====================================
#=====================================
WIDTH="1"
HAS_PLACEINS=""

header()
{
	cat <<EOF
\\documentclass[12pt]{article}
\\usepackage{listings}
\\usepackage{graphicx}
\\usepackage{hyperref}
\\usepackage{geometry}
\\usepackage{verbatim}
%\\usepackage{morefloats}
%\\usepackage{placeins}
\\title{Ganglia metric report}
\\date{$(date)}
\\author{$USER@$HOSTNAME}
%\\newgeometry{left=0.5cm,right=0.5cm,top=0.5cm,bottom=0.5cm}
\\newgeometry{left=2in,right=2in,top=0.5cm,bottom=0.5cm}

\\newcommand{\\FIG}[3]{
	\\begin{figure}[htb!]
		\\centering
		\\includegraphics[width=#2\\columnwidth,angle=0]{#1}
		\\caption{#3}
		\\label{fig:#1}
	\\end{figure}
}

\\newcommand{\\eqn}[1]{Eq.~(\\ref{#1})}
\\newcommand{\\fig}[1]{Fig.~\\ref{fig:#1}}
\\newcommand{\\tab}[1]{Tab.~\\ref{tab:#1}}

\\begin{document}
%\\twocolumn
\\maketitle
\\tableofcontents
\\newpage
EOF
}

#=====================================
footer()
{
	cat <<EOF
\\end{document}
EOF
}

#=====================================
new_subsec()
{
	title=$(echo $1 | tr '_' ' ')
	echo "\\subsection{$title}"
}

#=====================================
new_sec()
{
	title=$(echo $1 | tr '_' ' ')
	echo "\\section{$title}"
}

#=====================================
figure()
{
	file=$1
	caption=$(echo $2 | tr '_' ' ')
	echo "\\FIG{$file}{$WIDTH}{$caption}"
	if [ "$HAS_PLACEINS" ]
	then
		echo "\\FloatBarrier"
	fi
}
#=====================================
clearpage()
{
	echo "\\clearpage"
}
#=====================================
#=====================================

. spark_vars

if [ "$GANGLIA_METRICS" == "all" ]
then

	# get all metrics

	DIRS="$GANGLIA_SRC/$SPARK_MASTER"
	for node in $SPARK_SLAVE_NAMES
	do
		DIRS="$DIRS $GANGLIA_SRC/$node"
	done

	GANGLIA_METRICS=$(find $DIRS -name '*.rrd' \
		-a ! -wholename "*$GANGLIA_EXCLUDE*" \
		-exec basename {} .rrd \; 2>/dev/null \
		| sort | uniq)
fi

header 
# hardcode readme file... w/e
if [ -r readme ]; then
	cat readme
fi

for m in $GANGLIA_METRICS
do

	# plot master metrics
	if [ -r "$GANGLIA_IMG_DIR/$m-master.eps" ]
	then
		new_sec "$m: Master"
		figure $GANGLIA_IMG_DIR/$m-master.eps \
			"Measured $m of the master node across all runs."
	fi
	clearpage

	# mean iteration
	if [ -r "$GANGLIA_IMG_DIR/$m-per-it.eps" ]
	then
		new_sec "$m: Per Iteration"
		figure $GANGLIA_IMG_DIR/$m-per-it.eps \
			"$m per algorithm iteration, averaged over each iteration during runtime."
	fi

	# mean plot for all runs
	if [ -r "$GANGLIA_IMG_DIR/$m-mean.eps" ]
	then
		new_sec "$m: Average Slaves"
		figure $GANGLIA_IMG_DIR/$m-mean.eps \
			"Measured $m, averaged over all slaves during runtime. \
			Error bars show the standard deviation about the mean value."
	fi

	# histogram plot for all runs
	if [ -r "$GANGLIA_IMG_DIR/$m-hist.eps" ]
	then
		figure $GANGLIA_IMG_DIR/$m-hist.eps \
			"Average quantile plot of all slaves with error bars \
			showing standard deviation about the mean for $m over runtime."
	fi
	clearpage

	# plot individual slave metrics for all runs
	new_sec "$m: Individual Slaves"
	for d in $@
	do
		new_subsec "$d"
		if [ -r "$d/readme" ]
		then
			cat "$d/readme"
		fi
		if [ -r "$d/$GANGLIA_IMG_DIR/$m.eps" ]
		then
			figure "$d/$GANGLIA_IMG_DIR/$m.eps" \
				"Individual slave metrics over runtime for trial $d."
		fi

	done
	clearpage

done

footer
